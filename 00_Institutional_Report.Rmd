---
title: "Institution Report: SWiMS 2024 Data"
author: "actionuni Survey Team"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
bibliography: references.bib 
header-includes:
  - \usepackage{graphicx}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead[L]{\includegraphics[width=1.5cm]{actionuni_logo_klein.png}}
  - \fancyhead[C]{}
  - \fancyhead[R]{SWiMS 2024 Institution Report}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = FALSE, message = FALSE)
library(tidyverse)
library(kableExtra)
library(ggplot2)
library(readxl)
library(dplyr)
library(ggpattern)
```

```{r load-data, include=FALSE}
rm(list = ls())
# Load data
load("../data/SWiMS2024_Data_2025-03-24.RData") # ToDo: wir müssen unbedingt drauf achten dass alles nutzbar ist für beide ich kann data cleaningn icht nutzen weil mir ien objekt fehlt
source("99_helpers.R")


# Set target institution index manually
target_index <- 1  # Change this value to select the institution
institution_labels <- strsplit(codebook[codebook$VarName %in% "institution","Labels"],"//")[[1]]
target_institution <- institution_labels[target_index]
remaining_institutions <- setdiff(institution_labels, target_institution)

```

# TODO

- bei plots einbauen, dass kleine zellgrössen nicht geplotted / getabled werden

# Introduction

The **SWiMS 2024 Survey** explores the mental health and well-being of mid-level academic staff (e.g., doctoral researchers, scientific associates, postdocs, and other scientific staff) in Switzerland. The goal is to identify problems and areas for improvement in working conditions and research environments. This report focuses on the institution **`r target_institution`**, comparing its responses to those from other institutions.

---
  
# Sample Description
  
## Key Demographics
  
  The table below summarizes the key demographic characteristics of respondents from **`r target_institution`** compared to all other institution.

```{r sample-description}
# Select demographic variables
demographic_vars <- c("age", "gender", "mainPosition", "researchDiscipline", "phd")

demographics_summary <- dat %>%
  mutate(group = ifelse(institution == target_institution, "Target Institution", "Other Institutions")) %>%
  select(group, all_of(demographic_vars)) %>%
  pivot_longer(cols = all_of(demographic_vars), names_to = "Variable", values_to = "Value") %>%
  group_by(group, Variable, Value) %>%
  summarise(Count = n(), .groups = "drop") %>%
  group_by(group, Variable) %>%
  mutate(Proportion = round(Count / sum(Count),2))

# Create a table
summary_table <- demographics_summary %>%
  pivot_wider(names_from = group, values_from = c(Count, Proportion))

summary_table %>%
  kbl(caption = "Demographic Summary") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE)
```

## Response Rate

```{r}

institution_counts <- dat %>%
  group_by(inst) %>%
  summarise(count = n()) %>%
  filter(count > 10)

institution_counts <- institution_counts %>%
  left_join(dat.meta %>% select(Name, Members), by = c("inst" = "Name")) # add member numbers
institution_counts$response_rate <- institution_counts$count/institution_counts$Members



```

`r institution_counts[institution_counts$inst %in% target_institution,"count"]` responses were collected from `r target_institution` with a total number of members estimated at `r institution_counts[institution_counts$inst %in% target_institution,"Members"]` (taken from the actionuni reports on memberships), corresponding to a participation rate of `r round(institution_counts[institution_counts$inst %in% target_institution,"response_rate"]*100,1)`%.

# Key Variables

## Job Satisfaction 

Job satisfaction item by @dolbier_reliability_2005. 

```{r job satisfaction}

swims.plot.distribution(var = "jobSatisfaction", institution = target_institution)



```

## Supervisor
```{r supervisor}


swims.plot.multibar(var = "supervisor", institution = target_institution, colors_set = "RdYlGn",
                    ncol_plot = 4)


```

## Discrimination 

```{r}
swims.plot.multibar(var = "discrimination", institution = target_institution)
swims.plot.multibar(var = "discrimination_type", institution = target_institution)

```

## Aggregation function

```{r}

swims.plot.aggregation <- function(var, 
                                institution = target_institution, 
                                data = dat, 
                                codeb = codebook, 
                                fill_colors = NULL,
                                colors_set = "Set1", 
                                showCount = F
                                ){

  # 
  #vars <- "discrimination_type"
  #data = dat
  #codeb = codebook
  #fill_colors = NULL
  #colors_set = "Set1"
  #showCount = T
  
  # Define variable
    var_org <- var
    var <- codeb[codeb$Category %in% var,"VarName"]
    var_text <- data.frame("variable" = var,"text" = codeb[codeb$VarName %in% var,"Label"])
    
    # Ensure var exists in the codeb
    if (!all(var %in% codeb$VarName)) {
      stop(paste("Variable", var, "not found in the codeb."))
    }
    
    data.m <- reshape2::melt(data[,c("institution",var)], id.vars = "institution")
    
    # Use variable label if available
    x_label <- strsplit(codeb[codeb$VarName %in% var,"Labels"],"//")[[1]]
    
    # Prepare data for plotting
    plot_data <- data %>%
      mutate(group = ifelse(institution == target_institution, paste0(target_institution), "Other Institutions")) %>%
      mutate(group = factor(group, levels = c(setdiff(levels(factor(group)), "Other Institutions"), "Other Institutions"))) %>%
      filter(if_all(all_of(var), ~ !is.na(.)), !is.na(group)) %>%
      pivot_longer(cols = all_of(var), names_to = "variable", values_to = "value") %>%
      group_by(group, variable, value) %>%
      summarise(count = n(), .groups = "drop") %>%
      group_by(group, variable) %>%
      ungroup() 
      
    # Change values for varName
    plot_data <- plot_data %>%
      left_join(var_text, by = "variable") %>%
      select(-variable) %>% 
    mutate(text = factor(text, levels = var_text$text)) %>%# Order responses correctly
      mutate(text = str_wrap(text, width = 20)) %>% 
      filter(value %in% "quoted") %>% 
      group_by(group) %>%
    mutate(Percentage = count / sum(count))
    
    
    if(is.null(fill_colors)){
      fill_colors <- RColorBrewer::brewer.pal(n = min(length(unique(plot_data$text)), 9), name = colors_set)
      if (length(unique(plot_data$text)) > 9) {
        fill_colors <- colorRampPalette(fill_colors)(length(unique(plot_data$text)))
      }
    } 
      #c(myblue, myorange, myyellow, mypurple, mygreen)
    

    # Create plot
    plot_function <- function(plot_data) {

      # Plot erstellen
      g <- ggplot(plot_data[plot_data$value %in% "quoted",], aes(x = group, y = count, fill = text)) +  
        geom_bar(stat = "identity", position = "fill", width = 0.6) +  # Stacked Bar Chart
        labs(
          x = NULL,   # Entferne x-Achsen-Beschriftung
          y = "Percentage of Among All Named Categories",
          fill = "Category",
          title = ""
         # title = paste0("Comparison of Responses by Institution: ", var_org
         #)
        ) +
        scale_fill_manual(values = fill_colors) +  
        scale_y_continuous(labels = scales::percent)  +
        
        theme_minimal() +
        theme(
          text = element_text(size = 12),
          strip.text.y.left = element_text(size = 14, face = "bold", angle = 0),  # Lesbare Facet-Titel
          #axis.text.y = element_blank(),  # Entferne die ursprünglichen Gruppen-Namen links
          #axis.text.x = element_blank(),  # Entferne die x-Achsen-Beschriftungen
          #axis.title.x = element_blank(), # Entferne x-Achsen-Titel komplett
          axis.title = element_text(size = 12),
          legend.text = element_text(size = 10),
          legend.title = element_text(size = 10),
          plot.title = element_text(size = 14, hjust = 0.5)
        )
      
      if(showCount){return(g+
                             geom_text(aes(label = count),  position = position_fill(vjust = 0.5), size = 2, color = "white")) 
        }else{
      return(g)
      }
    }
    
    plot_function(plot_data)
    
}





swims.plot.aggregation(var = "discrimination_type", institution = target_institution, showCount = T) # showCount = T only for testing

```


  
# Key Variables
  
  The following plots compare the responses to key survey variables between **`r target_institution`** and all other institutions.

```{r key-variables}

```

# Appendix 

## Codebook

Detailed variable names, item formulations, etc. can be found in the codebook [link]

